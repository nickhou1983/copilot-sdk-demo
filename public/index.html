<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Copilot SDK Demo - 对话助手</title>
  <link rel="stylesheet" href="css/style.css">
  <!-- Highlight.js for code highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
</head>
<body>
  <div class="app-container">
    <!-- 侧边栏 -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <span class="logo-icon">🤖</span>
          <span>Copilot SDK Demo</span>
        </div>
        <button id="new-chat-btn" class="new-chat-btn">
          <span>➕</span>
          <span>新建对话</span>
        </button>
      </div>
      
      <!-- Agent 选择器 -->
      <div class="agent-selector-container">
        <div id="agent-selector" class="agent-selector">
          <!-- 动态渲染 -->
        </div>
      </div>
      
      <div class="sessions-list">
        <div class="sessions-title">会话历史</div>
        <div id="sessions-list">
          <!-- 会话列表将动态渲染 -->
        </div>
      </div>
      
      <div class="sidebar-footer">
        <div class="model-selector">
          <label for="model-select">选择模型</label>
          <select id="model-select">
            <option value="gpt-4o">GPT-4o</option>
          </select>
        </div>
        <button class="settings-btn" onclick="openSettingsModal()">
          ⚙️ 设置
        </button>
      </div>
    </aside>
    
    <!-- 主内容区 -->
    <main class="main-content">
      <!-- 头部 -->
      <header class="header">
        <h1 id="header-title" class="header-title">Copilot SDK Demo</h1>
        <div class="header-status">
          <span id="status-dot" class="status-dot"></span>
          <span id="status-text">连接中...</span>
        </div>
      </header>
      
      <!-- 聊天区域 -->
      <div id="chat-container" class="chat-container">
        <!-- 欢迎消息 -->
        <div id="welcome-message" class="welcome-message">
          <h2>👋 欢迎使用 Copilot SDK Demo</h2>
          <p>这是一个基于 GitHub Copilot CLI SDK 构建的对话助手演示应用，项目主要功能如下：</p>
          
          <div class="feature-grid">
            <div class="feature-card">
              <div class="feature-icon">💬</div>
              <div class="feature-title">流式对话</div>
              <div class="feature-desc">实时流式输出，交互更顺畅</div>
            </div>
            
            <div class="feature-card">
              <div class="feature-icon">🛠️</div>
              <div class="feature-title">工具调用</div>
              <div class="feature-desc">内置与自定义工具协同完成任务</div>
            </div>
            
            <div class="feature-card">
              <div class="feature-icon">🧠</div>
              <div class="feature-title">思考过程</div>
              <div class="feature-desc">展示模型推理过程（Reasoning）</div>
            </div>
            
            <div class="feature-card">
              <div class="feature-icon">📎</div>
              <div class="feature-title">文件附件</div>
              <div class="feature-desc">上传文件让 AI 分析内容</div>
            </div>
            
            <div class="feature-card">
              <div class="feature-icon">💾</div>
              <div class="feature-title">会话管理</div>
              <div class="feature-desc">支持创建、恢复与删除会话</div>
            </div>
            
            <div class="feature-card">
              <div class="feature-icon">🔄</div>
              <div class="feature-title">多模型切换</div>
              <div class="feature-desc">在多种 AI 模型间快速切换</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 输入区域 -->
      <div class="input-container">
        <div class="input-wrapper">
          <div id="attachments-preview" class="attachments-preview">
            <!-- 附件预览将动态渲染 -->
          </div>
          <div class="input-row">
            <div class="input-actions">
              <button id="attach-btn" class="action-btn" title="添加附件">
                📎
              </button>
            </div>
            <textarea 
              id="message-input" 
              class="message-input" 
              placeholder="输入消息，按 Enter 发送..."
              rows="1"
            ></textarea>
            <button id="send-btn" class="send-btn" title="发送">
              ➤
            </button>
          </div>
        </div>
        <input type="file" id="file-input" class="file-input" multiple>
      </div>
    </main>
  </div>
  
  <!-- Agent 管理模态框 -->
  <div id="agent-management-modal" class="modal">
    <div class="modal-content large">
      <div class="modal-header">
        <h2>Agent 管理</h2>
        <button class="modal-close" onclick="window.agentManager.closeAgentManagement()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-tabs">
          <button class="tab-btn active" onclick="switchTab('agents-tab')">Agents</button>
          <button class="tab-btn" onclick="switchTab('tools-tab')">工具</button>
          <button class="tab-btn" onclick="switchTab('groups-tab')">工具组</button>
        </div>
        
        <div id="agents-tab" class="tab-content active">
          <div class="tab-header">
            <h3>Agent 列表</h3>
            <button class="btn-primary" onclick="window.agentManager.openCreateAgentModal()">+ 创建 Agent</button>
          </div>
          <div id="agents-list" class="agents-list">
            <!-- 动态渲染 -->
          </div>
        </div>
        
        <div id="tools-tab" class="tab-content">
          <div class="tab-header">
            <h3>工具管理</h3>
            <button class="btn-primary" onclick="window.toolManager.openCreateToolModal()">+ 创建工具</button>
          </div>
          <div id="builtin-tools-list" class="tools-list">
            <!-- 内置工具列表 -->
          </div>
          <div id="custom-tools-list" class="tools-list">
            <!-- 自定义工具列表 -->
          </div>
        </div>
        
        <div id="groups-tab" class="tab-content">
          <div class="tab-header">
            <h3>工具组管理</h3>
            <button class="btn-secondary" onclick="window.toolManager.openCreateToolGroupModal()">+ 创建工具组</button>
          </div>
          <div id="tool-groups-list" class="tool-groups-list">
            <!-- 工具组列表 -->
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Agent 编辑模态框 -->
  <div id="agent-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="agent-modal-title">创建 Agent</h2>
        <button class="modal-close" onclick="window.agentManager.closeAgentModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="agent-form" onsubmit="event.preventDefault(); window.agentManager.saveAgent();">
          <div class="form-group">
            <label for="agent-name">名称 *</label>
            <input type="text" id="agent-name" required placeholder="例如：代码助手">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="agent-icon">图标</label>
              <input type="text" id="agent-icon" placeholder="🤖" maxlength="2">
            </div>
            <div class="form-group">
              <label for="agent-color">颜色</label>
              <input type="color" id="agent-color" value="#6366f1">
            </div>
          </div>
          
          <div class="form-group">
            <label for="agent-description">描述</label>
            <input type="text" id="agent-description" placeholder="简短描述 Agent 的用途">
          </div>
          
          <div class="form-group">
            <label for="agent-system-prompt">系统提示词</label>
            <textarea id="agent-system-prompt" rows="6" placeholder="定义 Agent 的行为和角色..."></textarea>
          </div>
          
          <div class="form-group">
            <label for="agent-preferred-model">首选模型</label>
            <select id="agent-preferred-model">
              <option value="">使用默认</option>
              <option value="claude-opus-4.5">Claude Opus 4.5</option>
              <option value="claude-sonnet-4.5">Claude Sonnet 4.5</option>
              <option value="claude-sonnet-4">Claude Sonnet 4</option>
              <option value="gpt-5.2-codex">GPT-5.2-Codex</option>
              <option value="gpt-4o">GPT-4o</option>
              <option value="gpt-4.1">GPT-4.1</option>
              <option value="o3-mini">o3-mini</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>工具组</label>
            <div id="tool-groups-select" class="checkbox-group">
              <!-- 动态渲染 -->
            </div>
          </div>
          
          <div class="form-group">
            <label>内置工具</label>
            <div id="builtin-tools-select" class="checkbox-group">
              <!-- 动态渲染 -->
            </div>
          </div>
          
          <div class="form-group">
            <label>自定义工具</label>
            <div id="custom-tools-select" class="checkbox-group">
              <!-- 动态渲染 -->
            </div>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="window.agentManager.closeAgentModal()">取消</button>
            <button type="submit" class="btn-primary">保存</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- 工具编辑模态框 -->
  <div id="tool-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="tool-modal-title">创建自定义工具</h2>
        <button class="modal-close" onclick="window.toolManager.closeToolModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="tool-form" onsubmit="event.preventDefault(); window.toolManager.saveTool();">
          <div class="form-group">
            <label for="tool-name">工具名称 * <small>(只能使用小写字母、数字和下划线)</small></label>
            <input type="text" id="tool-name" required placeholder="例如：search_web" pattern="[a-z][a-z0-9_]*">
          </div>
          
          <div class="form-group">
            <label for="tool-description">描述 *</label>
            <textarea id="tool-description" rows="2" required placeholder="描述工具的功能，AI 会根据此描述决定何时调用"></textarea>
          </div>
          
          <div class="form-group">
            <label for="tool-handler-type">处理器类型</label>
            <select id="tool-handler-type" onchange="window.toolManager.updateHandlerConfigUI(this.value)">
              <option value="http_get">HTTP GET</option>
              <option value="http_post">HTTP POST</option>
              <option value="javascript">JavaScript</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="tool-parameters">参数定义 <small>(JSON 数组格式)</small></label>
            <textarea id="tool-parameters" rows="4" placeholder='[{"name": "query", "type": "string", "description": "搜索关键词", "required": true}]'>[]</textarea>
          </div>
          
          <!-- HTTP 配置 -->
          <div id="http-handler-config">
            <div class="form-group">
              <label for="tool-url">URL * <small>(支持 {{参数名}} 占位符)</small></label>
              <input type="text" id="tool-url" placeholder="https://api.example.com/search?q={{query}}">
            </div>
            
            <div class="form-group">
              <label for="tool-headers">请求头 <small>(JSON 对象)</small></label>
              <textarea id="tool-headers" rows="2" placeholder='{"Authorization": "Bearer xxx"}'>{}</textarea>
            </div>
            
            <div class="form-group" id="body-template-group" style="display: none;">
              <label for="tool-body-template">请求体模板 <small>(JSON 字符串，支持占位符)</small></label>
              <textarea id="tool-body-template" rows="3" placeholder='{"query": "{{query}}", "limit": 10}'></textarea>
            </div>
            
            <div class="form-group">
              <label for="tool-result-path">结果路径 <small>(可选，例如 data.items)</small></label>
              <input type="text" id="tool-result-path" placeholder="data.results">
            </div>
          </div>
          
          <!-- JavaScript 配置 -->
          <div id="js-handler-config" style="display: none;">
            <div class="form-group">
              <label for="tool-js-code">JavaScript 代码 <small>(可使用 args 获取参数，返回结果)</small></label>
              <textarea id="tool-js-code" rows="8" placeholder="// args 包含所有参数
const result = args.text.toUpperCase();
return { result };"></textarea>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="window.toolManager.closeToolModal()">取消</button>
            <button type="submit" class="btn-primary">保存</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <!-- 设置模态框 -->
  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>设置</h2>
        <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="settings-section">
          <h3>Agent 管理</h3>
          <p>创建和管理自定义 Agent，为不同场景配置专属助手。</p>
          <button class="btn-primary" onclick="closeSettingsModal(); window.agentManager.openAgentManagement();">
            管理 Agents
          </button>
        </div>
        <div class="settings-section">
          <h3>关于</h3>
          <p>Copilot SDK Demo v1.0</p>
          <p>基于 GitHub Copilot CLI SDK 构建的对话助手演示应用。</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 用户输入请求对话框 -->
  <div id="user-input-dialog" class="user-input-overlay">
    <div class="user-input-dialog">
      <div class="user-input-header">
        <span class="user-input-icon">🙋</span>
        <span>AI 需要你的输入</span>
      </div>
      <div id="user-input-question" class="user-input-question"></div>
      <div id="user-input-choices" class="user-input-choices"></div>
      <div id="user-input-freeform" class="user-input-freeform">
        <textarea id="user-input-text" class="user-input-text" placeholder="输入你的回答..." rows="2"></textarea>
        <button id="user-input-submit" class="btn-primary user-input-submit">提交</button>
      </div>
    </div>
  </div>

  <!-- 依赖库 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="js/agentManager.js"></script>
  <script src="js/toolManager.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
